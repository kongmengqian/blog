# 浏览器原理

## 进程和线程

1. 以多进程的方式，允许多个任务同时运行。——一个工厂（CPU）可以一个车间或多个车间同时工作（允许多任务同时运行）。
2. 以多线程的方式，允许单个任务分多个不同的部分运行。——一个车间（进程）会有很多种类的工人（线程），他们可以独自完成工作，也可以多个配合完成工作（允许单个任务分多个不同的部分运行）。
3. 提供协调机制，一方面阻止多个进程和多个线程之间的冲突，另一方面允许进程之间和线程之间共享资源。——厕所只有 3 个坑，最多容纳 3 个人（信号量），每个坑一次只能进一个人，进去的人要锁门，出来的时候打开（互斥锁）。这个厕所的坑位是对整个车间的工人（线程）开放的（共享空间资源）。
4. 每个进程都有自己独立的内存空间，保证了进程之间相互独立，互不影响。进程与进程之间通过 IPC（Inter Process Communication）进行通信。

## 从在浏览器地址栏中输入 url 到页面展现的短短几秒内浏览器究竟做了什么？

### 1.DNS 解析：一个网址到 IP 地址的转换

### 2.TCP 三次握手，建立连接

1. 建立连接。客户端发送 `SYN(seq=x)`报文到服务器，进入 `SYN_SEND` 状态，等待服务器确认
2. 服务器收到 `SYN` 报文。服务器收到 SYN 报文并确认，设置 `ACK（seq+1）`，同时也发送 `SYN（seq=y）`，即 `SYN+ACK` 报文，服务端进入 `SYN_RECV` 状态
3. 客户端收到服务器的 `SYN+ACK` 报文。设置 `ack（y+1）`，向服务器发送 `ACK` 报文，发送完毕，两者建立连接，进入 `ESTABLISHED` 状态

### 3.浏览器发送请求

### 4.服务器收到、解析、处理请求，返回数据

### 5.浏览器读取响应，根据 Content-Type 类型调用不同的进程，进入下一阶段。

> 浏览器安全检查也会在此触发，是否来自已知恶意站点。`CORB` 检测（`Cross-Origin Read Blocking`）也会触发。

### 6.浏览器解析文件（以 HTML 文件为例）

### 7.构建 DOM 树

> `DOM` 树构建完成后会触发`DOMContentLoaded`事件

当初始的 `HTML` 文档被完全加载和解析完成之后，`DOMContentLoaded` 事件被触发，而**无需等待样式表、图像和子框架的完全加载**。另一个不同的事件 `load` 应该仅用于检测一个完全加载的页面。 这里有一个常见的错误，就是在本应使用 `DOMContentLoaded` 会更加合适的情况下，却选择使用 `load`，所以要谨慎。注意：`DOMContentLoaded` 事件必须等待其所属 `script` 之前的样式表**加载解析完成**才会触发。——DOMContentLoaded - 事件参考 | MDN

### 8.加载 css，img，js 等资源文件

`async`：异步加载，加载结束后，立即执行，属于无序加载，会阻塞 `DOM` 构建。

`defer`：异步加载，延迟执行（等 `HTML` 解析好了之后），再执行，有序加载。

普通：同步加载，加载结束后，立即执行。阻塞 `DOM` 构建。

### 9.构建 CSSOM（CSS Object Model）树

### 10.生成渲染树

### 11.布局（回流），计算出每个树结点的位置和大小

### 12.绘制，调用 GPU 绘制，合成图层，显示在屏幕上

## 参考资料

- [进程与线程的一个简单解释](http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html)(CPU-工厂；进程-车间；线程-工人，图文类比，非常形象)
- [图解浏览器的基本工作原理](https://zhuanlan.zhihu.com/p/47407398)(通过浏览器的进程、线程清楚的描述了浏览器的基本工作原理，非常详细)
- [深入浅出浏览器渲染原理](https://zhuanlan.zhihu.com/p/53913989)(描述了渲染进程中浏览器的工作原理，解释了 DOM 树的构建内部实现机制)
- [前端经典面试题: 从输入 URL 到页面加载发生了什么？](https://segmentfault.com/a/1190000006879700)(DNS 解析过程、http 请求过程写的比较详细)
- [通俗大白话来理解 TCP 协议的三次握手和四次分手](https://github.com/jawil/blog/issues/14)(通俗易懂的举例+专业知识的描述)
- [【浏览器渲染原理】解析和 DOM 树构建之 HTML 解析器](https://blog.csdn.net/greenqingqingws/article/details/19163061)(从服务端拿到的 html 文件-->进到浏览器的 HTML 解析器，解析算法：标记化（词法分析)+树构造-->浏览器中的真实 DOM)
